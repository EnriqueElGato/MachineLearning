---
title: "Practical Machine Learning"
output: html_document
---

## Synopsis

This analysis will choose a prediction model with which to train, test and then perform predictions for 20 sample cases.

This document will describe how the model was built, how cross validation was used and what the epxected out of sample error rate will be. 

## Loading and Reviewing The Data

The data for this analysis came from this site: [http://groupware.les.inf.puc-rio.br/har](http://groupware.les.inf.puc-rio.br/har).

```{r echo=FALSE}

setwd("C:\\Users\\Eric\\Documents\\dev\\docs\\MachineLearning\\project")

```

```{r echo=TRUE}
if (!file.exists("pml-training.csv")) {
        link <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
        download.file(link, destfile = "./pml-training.csv",method="curl")
        link <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
        download.file(link, destfile = "./pml-testing.csv",method="curl")
}
data <- read.csv("pml-training.csv")
```

## Choosing A Model

I decided to use a Random Forest model since the outcome that will be predicted is categorical and, per our instructor, it is one of the most accurate modles.

## Creating Training And Test Datasets

Below is the code used to split the sample data into test and training datasets. A split of 70/30 will be used.

```{r,echo=TRUE,warning=FALSE,message=FALSE}
library(caret,quietly=TRUE,warn.conflicts=FALSE);
set.seed(32323)
inTrain <- createDataPartition(y=data$classe,
                               p=0.70, list=FALSE)
training <- data[inTrain,]
testing <- data[-inTrain,]

```

## Selecting Predictors

The predictors used in the model will be the same ones that are present in the pml-testing.csv file less the following fields as they are not predictors:

* user_name
* new_window
* num_window
* classe

The '''fieldFilter''' variable below is a vector that reflects these choices.

```{r echo=FALSE}

fieldsFilter <- c("roll_belt","pitch_belt","yaw_belt",	"total_accel_belt",	"gyros_belt_x",	"gyros_belt_y",	"gyros_belt_z",	"accel_belt_x",	"accel_belt_y",	"accel_belt_z",	"magnet_belt_x",	"magnet_belt_y",	"magnet_belt_z",	"roll_arm",	"pitch_arm",	"yaw_arm",	"total_accel_arm",	"gyros_arm_x",	"gyros_arm_y",	"gyros_arm_z",	"accel_arm_x",	"accel_arm_y",	"accel_arm_z",	"magnet_arm_x",	"magnet_arm_y",	"magnet_arm_z",	"roll_dumbbell",	"pitch_dumbbell",	"yaw_dumbbell",	"total_accel_dumbbell",	"gyros_dumbbell_x",	"gyros_dumbbell_y",	"gyros_dumbbell_z",	"accel_dumbbell_x",	"accel_dumbbell_y",	"accel_dumbbell_z",	"magnet_dumbbell_x",	"magnet_dumbbell_y",	"magnet_dumbbell_z",	"roll_forearm",	"pitch_forearm",	"yaw_forearm",	"total_accel_forearm",	"gyros_forearm_x",	"gyros_forearm_y",	"gyros_forearm_z",	"accel_forearm_x",	"accel_forearm_y",	"accel_forearm_z",	"magnet_forearm_x",	"magnet_forearm_y",	"magnet_forearm_z",	"classe")

```

```{r echo=TRUE}
dTrain <- training[,fieldsFilter]
dTest <-   testing[,fieldsFilter]

```

## Model Training

I used an Amazon Linux AMI m4.2xlarge Unix host with 8 cores and 32 gigs of primary memory. Creating one of these instances is cheap and easy. An account can be created [here](http://aws.amazon.com/). I installed R Studio using instructions that can be found [here](http://www.louisaslett.com/RStudio_AMI/).

Once the model was created, I saved it to disk and copied it to my workstation. The size of the file was 85 megabytes. It took about 15 minutes to train the data.

The code below either creats or loads the model.

A five fold cross validation method was used.

As the print of the model shows, this model has a 99% accuracy rate. 

```{r echo=TRUE}
if (file.exists("fit_rf_cv5.rds")) {
        modFit = readRDS("fit_rf_cv5.rds")
}else{        
        date()
        library(doParallel)
        registerDoParallel(cores=8)
        ctrl <- trainControl(method="cv",number=5)
        set.seed(32323)
        system.time(modFit <- train(classe~ .,data=dTrain,method="rf"
                            ,prox=TRUE
                            ,trControl=ctrl)
                    )
        saveRDS(modFit, file="fit_rf_cv5.rds")           
}
print(modFit)

```

## Model Testing

Now that the model is created, it will be tested against the testing dataset.

```{r,echo=TRUE,warning=FALSE,message=FALSE}
library(xtable,quietly=TRUE,warn.conflicts = FALSE)
pred <- predict(modFit,dTest[,-53]); 
dTest$predRight <- pred==dTest$classe
OOSErrPred <- sum(!dTest$predRight)/nrow(dTest)
t1 <- round(table(pred,dTest$classe),digits = 0)
t2 <- round(table(pred,dTest$classe)/nrow(dTest),digits = 2)
```

Based on the test results above the out off sample preditced error is `r OOSErrPred`. This was calcualted by taking the predictions generated by the traing data model and comparing it to the test data's observed outcome values.

```{r,results='asis',echo=FALSE,warning=FALSE,message=FALSE}
xt<-xtable(t1,digits = 0,caption="Prediction Vs Test Actuals Cross Tabulation")
print(xt,type = "html",comment=FALSE,html.table.attributes = getOption("xtable.html.table.attributes",'border="1"" align="center"" cellpadding=2 cellspacing=2'))
```

```{r,results='asis',echo=FALSE,warning=FALSE,message=FALSE}
xt<-xtable(t2,digits = 2,caption="Prediction Vs Test Actuals Ratio Cross Tabulation")
print(xt,type = "html",comment=FALSE,html.table.attributes = getOption("xtable.html.table.attributes",'border="1"" align="center"" cellpadding="20" cellspacing="20"'))

```

## Model Test Predictions - 20 Test Cases

As input into the prediction model, all the fields that are populated in the pml-testing.csv file will be used except as they are not predictors:

* user_name
* raw_timestamp_part_1
* raw_timestamp_part_2
* problem_id

Fortunately all columns of data that were populated at all wer completely populated. No imputing or data dropping was done. The fields not populated in the 20 sample test file were summary statistics calculated at the end of every window in the training data. Again, none of these fields were used in the training, testing or 20 sample test set predicting.

The '''fieldFilter''' varible below captures these fields.

```{r,echo=FALSE}
fieldFilter <- c("user_name","raw_timestamp_part_1","raw_timestamp_part_2",
          "roll_belt",        "pitch_belt",        "yaw_belt",	"total_accel_belt",	"gyros_belt_x",	"gyros_belt_y",	"gyros_belt_z",	"accel_belt_x",	"accel_belt_y",	"accel_belt_z",	"magnet_belt_x",	"magnet_belt_y",	"magnet_belt_z",	"roll_arm",	"pitch_arm",	"yaw_arm",	"total_accel_arm",	"gyros_arm_x",	"gyros_arm_y",	"gyros_arm_z",	"accel_arm_x",	"accel_arm_y",	"accel_arm_z",	"magnet_arm_x",	"magnet_arm_y",	"magnet_arm_z",	"roll_dumbbell",	"pitch_dumbbell",	"yaw_dumbbell",	"total_accel_dumbbell",	"gyros_dumbbell_x",	"gyros_dumbbell_y",	"gyros_dumbbell_z",	"accel_dumbbell_x",	"accel_dumbbell_y",	"accel_dumbbell_z",	"magnet_dumbbell_x",	"magnet_dumbbell_y",	"magnet_dumbbell_z",	"roll_forearm",	"pitch_forearm",	"yaw_forearm",	"total_accel_forearm",	"gyros_forearm_x",	"gyros_forearm_y",	"gyros_forearm_z",	"accel_forearm_x",	"accel_forearm_y",	"accel_forearm_z",	"magnet_forearm_x",	"magnet_forearm_y",	"magnet_forearm_z",
          "problem_id")
```

```{r,echo=TRUE}
dataTest <- read.csv("pml-testing.csv")
dTestTrim <- dataTest[,fieldFilter]
dTestTrim$pred <- predict(modFit,dTestTrim[,c(-1,-2,-3,-56)]); 
#dTestTrim[,c("user_name","raw_timestamp_part_1","raw_timestamp_part_2","problem_id","pred")]
```

Below is the code that was used to write out the the prediction created using the model and 20 samples test input file.

```
pml_write_files = function(x){
        n = length(x)
        for(i in 1:n){
                filename = paste0("./output/problem_id_",i,".txt")
                write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
        }
}
pml_write_files(dTestTrim$pred)
```
Per the Course Project submission site, all the prediction make for the 20 samples were correct. 




